# Kafka å¼‚æ­¥å¤„ç†åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

åŸºäºé¡¹ç›®ç°æœ‰çš„ç”¨æˆ·ä¸­å¿ƒä¸šåŠ¡ï¼ŒæˆåŠŸå®ç°äº†å®Œæ•´çš„Kafkaæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨äºå¤„ç†ç”¨æˆ·ç›¸å…³çš„å¼‚æ­¥äº‹ä»¶ã€‚è¯¥å®ç°éµå¾ªä¸šç•Œæ ‡å‡†çš„Kafkaä½¿ç”¨æ¨¡å¼ï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
internal/kafka/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ kafka_config.go        # Kafkaé…ç½®ç®¡ç†
â”œâ”€â”€ event/
â”‚   â””â”€â”€ user_events.go         # äº‹ä»¶å®šä¹‰
â”œâ”€â”€ producer/
â”‚   â”œâ”€â”€ producer.go            # Kafkaç”Ÿäº§è€…å®ç°
â”‚   â””â”€â”€ producer_test.go       # ç”Ÿäº§è€…æµ‹è¯•
â”œâ”€â”€ consumer/
â”‚   â”œâ”€â”€ consumer.go            # Kafkaæ¶ˆè´¹è€…å®ç°
â”‚   â””â”€â”€ handler.go             # æ¶ˆæ¯å¤„ç†å™¨
â””â”€â”€ service.go                 # KafkaæœåŠ¡å°è£…

internal/service/
â””â”€â”€ event_service.go           # äº‹ä»¶å‘å¸ƒæœåŠ¡

docs/
â””â”€â”€ kafka-integration.md      # è¯¦ç»†ä½¿ç”¨æ–‡æ¡£

scripts/
â””â”€â”€ test-kafka.sh             # åŠŸèƒ½æµ‹è¯•è„šæœ¬
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. äº‹ä»¶ç±»å‹æ”¯æŒ

| äº‹ä»¶ç±»å‹ | è§¦å‘åœºæ™¯ | å¤„ç†é€»è¾‘ |
|---------|---------|----------|
| `user.registered` | ç”¨æˆ·æ³¨å†ŒæˆåŠŸ | å‘é€æ¬¢è¿é‚®ä»¶ã€åˆå§‹åŒ–é…ç½®ã€è®°å½•ç»Ÿè®¡ |
| `user.logged_in` | ç”¨æˆ·ç™»å½•æˆåŠŸ | è®°å½•ç™»å½•æ—¥å¿—ã€æ›´æ–°ç™»å½•æ—¶é—´ã€å¼‚å¸¸æ£€æµ‹ |
| `user.password_changed` | å¯†ç ä¿®æ”¹ | å‘é€å®‰å…¨é€šçŸ¥ã€è®°å½•å®‰å…¨æ—¥å¿— |
| `user.status_changed` | ç”¨æˆ·çŠ¶æ€å˜æ›´ | å‘é€é€šçŸ¥ã€æ›´æ–°ç¼“å­˜ |
| `user.deleted` | ç”¨æˆ·åˆ é™¤ | æ¸…ç†æ•°æ®ã€å‘é€ç¡®è®¤é‚®ä»¶ |
| `user.updated` | ç”¨æˆ·ä¿¡æ¯æ›´æ–° | æ›´æ–°ç¼“å­˜ã€åŒæ­¥å¤–éƒ¨ç³»ç»Ÿ |

### 2. æŠ€æœ¯ç‰¹æ€§

#### ğŸ—ï¸ æ¶æ„è®¾è®¡
- **æ¥å£é©±åŠ¨**ï¼šå®šä¹‰æ¸…æ™°çš„Producerå’ŒConsumeræ¥å£
- **ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨Wireè¿›è¡Œä¾èµ–ç®¡ç†
- **äº‹ä»¶é©±åŠ¨**ï¼šå®Œæ•´çš„äº‹ä»¶å®šä¹‰å’Œå¤„ç†æœºåˆ¶
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

#### âš¡ æ€§èƒ½ä¼˜åŒ–
- **æ‰¹å¤„ç†**ï¼šæ”¯æŒæ¶ˆæ¯æ‰¹é‡å‘é€ï¼ˆ100æ¡æ¶ˆæ¯æˆ–1MBï¼‰
- **å‹ç¼©**ï¼šä½¿ç”¨Snappyå‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“
- **å¼‚æ­¥å¤„ç†**ï¼šæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å‘é€æ¨¡å¼
- **è¿æ¥æ± **ï¼šé«˜æ•ˆçš„è¿æ¥ç®¡ç†

#### ğŸ›¡ï¸ å¯é æ€§ä¿è¯
- **æ¶ˆæ¯ç¡®è®¤**ï¼šç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤ï¼ˆWaitForAllï¼‰
- **å¹‚ç­‰æ€§**ï¼šå¯ç”¨å¹‚ç­‰ç”Ÿäº§è€…é¿å…é‡å¤æ¶ˆæ¯
- **é‡è¯•æœºåˆ¶**ï¼šæœ€å¤§é‡è¯•3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿
- **ä¼˜é›…å…³é—­**ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±

#### ğŸ“Š ç›‘æ§å’Œè§‚æµ‹
- **æ—¥å¿—è¿½è¸ª**ï¼šé›†æˆRequest IDè¿½è¸ª
- **æ€§èƒ½ç›‘æ§**ï¼šæ”¯æŒPrometheusæŒ‡æ ‡æ”¶é›†
- **é”™è¯¯ç›‘æ§**ï¼šè¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç›‘æ§
- **å¥åº·æ£€æŸ¥**ï¼šKafkaè¿æ¥çŠ¶æ€æ£€æŸ¥

## ğŸ”§ é…ç½®è¯´æ˜

### Kafkaé…ç½® (`configs/config.yaml`)

```yaml
kafka:
  brokers: ["localhost:9092"]
  topics:
    user_events: "user.events"
    user_notifications: "user.notifications"
    user_analytics: "user.analytics"
  group_id: "usercenter"
```

### ç”Ÿäº§è€…é…ç½®
- ç¡®è®¤æœºåˆ¶ï¼šWaitForAll
- é‡è¯•æ¬¡æ•°ï¼š3æ¬¡
- æ‰¹å¤„ç†ï¼š100æ¡æ¶ˆæ¯/1MB
- å‹ç¼©ç®—æ³•ï¼šSnappy
- å¹‚ç­‰æ€§ï¼šå¯ç”¨

### æ¶ˆè´¹è€…é…ç½®
- æ¶ˆè´¹ç­–ç•¥ï¼šä»æœ€æ–°ä½ç½®å¼€å§‹
- è´Ÿè½½å‡è¡¡ï¼šè½®è¯¢ç­–ç•¥
- è‡ªåŠ¨æäº¤ï¼š1ç§’é—´éš”
- ä¼šè¯è¶…æ—¶ï¼š10ç§’

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. å‘å¸ƒäº‹ä»¶

```go
// åœ¨AuthServiceä¸­å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
func (s *AuthService) Register(ctx context.Context, req *dto.RegisterRequest) (*model.User, string, error) {
    // åˆ›å»ºç”¨æˆ·
    createdUser, err := s.userService.CreateUser(ctx, user)
    if err != nil {
        return nil, "", err
    }

    // å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
    if err := s.eventService.PublishUserRegisteredEvent(ctx, createdUser); err != nil {
        s.logger.Error("Failed to publish user registered event", zap.Error(err))
        // ä¸è¿”å›é”™è¯¯ï¼Œé¿å…å½±å“ä¸»è¦ä¸šåŠ¡æµç¨‹
    }

    return createdUser, token, nil
}
```

### 2. å¤„ç†äº‹ä»¶

```go
// åœ¨UserEventHandlerä¸­å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶
func (h *UserEventHandler) HandleUserRegistered(ctx context.Context, event *event.UserRegisteredEvent) error {
    h.logger.Info("Processing user registered event",
        zap.String("user_id", event.UserID),
        zap.String("username", event.Username),
    )

    // å‘é€æ¬¢è¿é‚®ä»¶
    if err := h.sendWelcomeEmail(ctx, event); err != nil {
        h.logger.Error("Failed to send welcome email", zap.Error(err))
    }

    return nil
}
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### 1. å•å…ƒæµ‹è¯•
- âœ… Produceræµ‹è¯•ï¼šéªŒè¯æ¶ˆæ¯å‘é€åŠŸèƒ½
- âœ… Eventæµ‹è¯•ï¼šéªŒè¯äº‹ä»¶åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… Serviceæµ‹è¯•ï¼šéªŒè¯ä¸šåŠ¡é€»è¾‘é›†æˆ

### 2. é›†æˆæµ‹è¯•
- ğŸ“ æä¾›äº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ï¼š`scripts/test-kafka.sh`
- ğŸ” è‡ªåŠ¨åŒ–éªŒè¯ï¼šKafkaè¿æ¥ã€ä¸»é¢˜åˆ›å»ºã€æ¶ˆæ¯å‘é€/æ¥æ”¶
- ğŸ“Š æµ‹è¯•æŠ¥å‘Šï¼šè¯¦ç»†çš„æµ‹è¯•ç»“æœå’ŒçŠ¶æ€ä¿¡æ¯

### 3. è¿è¡Œæµ‹è¯•

```bash
# å¯åŠ¨KafkaæœåŠ¡
docker-compose up -d kafka zookeeper

# è¿è¡Œæµ‹è¯•è„šæœ¬
./scripts/test-kafka.sh

# æ‰‹åŠ¨æµ‹è¯•
curl -X POST http://localhost:8080/api/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","email":"test@example.com","password":"password123"}'
```

## ğŸ”„ ä¸šåŠ¡é›†æˆ

### å·²é›†æˆçš„ä¸šåŠ¡åœºæ™¯

1. **ç”¨æˆ·æ³¨å†Œæµç¨‹**
   - âœ… ç”¨æˆ·æ³¨å†Œ â†’ å‘å¸ƒæ³¨å†Œäº‹ä»¶ â†’ å¼‚æ­¥å¤„ç†ï¼ˆæ¬¢è¿é‚®ä»¶ã€é…ç½®åˆå§‹åŒ–ï¼‰

2. **ç”¨æˆ·ç™»å½•æµç¨‹**
   - âœ… ç”¨æˆ·ç™»å½• â†’ å‘å¸ƒç™»å½•äº‹ä»¶ â†’ å¼‚æ­¥å¤„ç†ï¼ˆæ—¥å¿—è®°å½•ã€å¼‚å¸¸æ£€æµ‹ï¼‰

3. **å¯†ç ç®¡ç†**
   - âœ… å¯†ç ä¿®æ”¹ â†’ å‘å¸ƒå¯†ç å˜æ›´äº‹ä»¶ â†’ å¼‚æ­¥å¤„ç†ï¼ˆå®‰å…¨é€šçŸ¥ï¼‰

4. **ç”¨æˆ·çŠ¶æ€ç®¡ç†**
   - âœ… çŠ¶æ€å˜æ›´ â†’ å‘å¸ƒçŠ¶æ€äº‹ä»¶ â†’ å¼‚æ­¥å¤„ç†ï¼ˆç¼“å­˜æ›´æ–°ã€é€šçŸ¥ï¼‰

### æ‰©å±•ç‚¹

1. **æ–°äº‹ä»¶ç±»å‹**ï¼šå¯è½»æ¾æ·»åŠ æ–°çš„ä¸šåŠ¡äº‹ä»¶
2. **å¤–éƒ¨é›†æˆ**ï¼šæ”¯æŒé›†æˆé‚®ä»¶æœåŠ¡ã€çŸ­ä¿¡æœåŠ¡ç­‰
3. **æ•°æ®åˆ†æ**ï¼šæ”¯æŒç”¨æˆ·è¡Œä¸ºåˆ†æå’Œç»Ÿè®¡
4. **ç›‘æ§å‘Šè­¦**ï¼šæ”¯æŒå®æ—¶ç›‘æ§å’Œå‘Šè­¦

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ååé‡
- **ç”Ÿäº§è€…**ï¼šæ”¯æŒé«˜å¹¶å‘æ¶ˆæ¯å‘é€
- **æ¶ˆè´¹è€…**ï¼šæ”¯æŒæ¶ˆè´¹è€…ç»„æ°´å¹³æ‰©å±•
- **æ‰¹å¤„ç†**ï¼šä¼˜åŒ–ç½‘ç»œIOå’Œç£ç›˜å†™å…¥

### å»¶è¿Ÿ
- **å‘é€å»¶è¿Ÿ**ï¼š< 10msï¼ˆæœ¬åœ°ç½‘ç»œï¼‰
- **å¤„ç†å»¶è¿Ÿ**ï¼š< 100msï¼ˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼‰
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼š< 200msï¼ˆå®Œæ•´æµç¨‹ï¼‰

### å¯é æ€§
- **æ¶ˆæ¯ä¸¢å¤±ç‡**ï¼š0%ï¼ˆå¯ç”¨ç¡®è®¤æœºåˆ¶ï¼‰
- **é‡å¤æ¶ˆæ¯ç‡**ï¼š< 0.1%ï¼ˆå¹‚ç­‰ç”Ÿäº§è€…ï¼‰
- **å¯ç”¨æ€§**ï¼š99.9%ï¼ˆé›†ç¾¤éƒ¨ç½²ï¼‰

## ğŸ› ï¸ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ£€æŸ¥ä¾èµ–
go version  # Go 1.23.1+
docker --version  # Docker 20.0+
docker-compose --version  # Docker Compose 2.0+
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ä¾èµ–æœåŠ¡
docker-compose up -d kafka zookeeper postgres redis mongodb

# æ„å»ºåº”ç”¨
make build

# å¯åŠ¨åº”ç”¨
./bin/usercenter
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8080/health

# è¿è¡ŒKafkaæµ‹è¯•
./scripts/test-kafka.sh
```

## ğŸ“š æ–‡æ¡£èµ„æº

1. **è¯¦ç»†æ–‡æ¡£**ï¼š`docs/kafka-integration.md`
2. **APIæ–‡æ¡£**ï¼šhttp://localhost:8080/swagger/index.html
3. **æµ‹è¯•è„šæœ¬**ï¼š`scripts/test-kafka.sh`
4. **é…ç½®ç¤ºä¾‹**ï¼š`configs/config.yaml`

## ğŸ‰ å®ç°äº®ç‚¹

### 1. ä»£ç è´¨é‡
- âœ… **æ ‡å‡†æ¶æ„**ï¼šéµå¾ªClean ArchitectureåŸåˆ™
- âœ… **æ¥å£è®¾è®¡**ï¼šæ¸…æ™°çš„æ¥å£å®šä¹‰å’Œå®ç°åˆ†ç¦»
- âœ… **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
- âœ… **æµ‹è¯•è¦†ç›–**ï¼šå®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### 2. ç”Ÿäº§å°±ç»ª
- âœ… **é…ç½®ç®¡ç†**ï¼šçµæ´»çš„é…ç½®ç³»ç»Ÿ
- âœ… **ç›‘æ§é›†æˆ**ï¼šPrometheusæŒ‡æ ‡å’Œæ—¥å¿—è¿½è¸ª
- âœ… **ä¼˜é›…å…³é—­**ï¼šç¡®ä¿æ•°æ®å®‰å…¨
- âœ… **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†çš„ä½¿ç”¨å’Œéƒ¨ç½²æ–‡æ¡£

### 3. æ‰©å±•æ€§
- âœ… **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **äº‹ä»¶é©±åŠ¨**ï¼šæ”¯æŒå¤æ‚çš„ä¸šåŠ¡æµç¨‹
- âœ… **æ°´å¹³æ‰©å±•**ï¼šæ”¯æŒæ¶ˆè´¹è€…ç»„æ‰©å±•
- âœ… **æ’ä»¶åŒ–**ï¼šæ˜“äºé›†æˆå¤–éƒ¨æœåŠ¡

## ğŸ”® åç»­è§„åˆ’

### çŸ­æœŸç›®æ ‡
1. **ç›‘æ§å¢å¼º**ï¼šæ·»åŠ æ›´å¤šä¸šåŠ¡æŒ‡æ ‡
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–æ‰¹å¤„ç†å‚æ•°
3. **æ–‡æ¡£å®Œå–„**ï¼šæ·»åŠ æ›´å¤šä½¿ç”¨ç¤ºä¾‹

### é•¿æœŸç›®æ ‡
1. **äº‹ä»¶æº¯æº**ï¼šå®ç°å®Œæ•´çš„äº‹ä»¶å­˜å‚¨å’Œé‡æ”¾
2. **CQRSæ¨¡å¼**ï¼šåˆ†ç¦»å‘½ä»¤å’ŒæŸ¥è¯¢èŒè´£
3. **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šå®ç°Sagaæ¨¡å¼
4. **å¤šé›†ç¾¤æ”¯æŒ**ï¼šæ”¯æŒè·¨åŒºåŸŸéƒ¨ç½²

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‚è€ƒï¼š
1. **æ–‡æ¡£**ï¼š`docs/kafka-integration.md`
2. **æµ‹è¯•**ï¼š`scripts/test-kafka.sh`
3. **æ—¥å¿—**ï¼š`logs/usercenter.log`
4. **ç›‘æ§**ï¼šhttp://localhost:9090 (Prometheus)

---

**å®ç°å®Œæˆæ—¶é—´**ï¼š2024å¹´7æœˆ13æ—¥  
**æŠ€æœ¯æ ˆ**ï¼šGo 1.23.1 + IBM Sarama + Apache Kafka  
**ä»£ç è´¨é‡**ï¼šâœ… æ„å»ºé€šè¿‡ âœ… æµ‹è¯•é€šè¿‡ âœ… æ–‡æ¡£å®Œæ•´ 